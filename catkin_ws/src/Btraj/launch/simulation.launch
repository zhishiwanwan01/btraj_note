<!--
BTraj 无人机轨迹规划仿真启动文件
===================================
此启动文件协调一个完整的基于ROS的无人机轨迹规划仿真，使用BTraj框架。
它实现了两阶段规划方法：
1. 前端路径搜索 (Fast Marching* 或 A*)
2. 后端贝塞尔曲线轨迹优化

仿真创建一个包含障碍物的虚拟森林环境，演示四旋翼安全轨迹生成。

ROS背景知识：
- launch文件：XML格式配置文件，同时启动多个ROS节点
- 节点(nodes)：独立的ROS程序，通过话题/服务通信
- 重映射(remap)：重定向话题名称，实现灵活的系统架构
- 参数(param)：设置节点可通过ROS参数服务器访问的配置参数
- 参数(args)：启动时可覆盖的命令行参数
- output参数：控制节点输出位置
  * output="screen" - 输出到终端(调试用)
  * output="log" - 输出到日志文件(生产用)
  * 省略 - 默认使用log模式

为什么算法参数放在launch文件而不是代码中：
1. 运行时可配置：修改参数无需重新编译
2. 多场景适应：同一代码适配不同环境/任务
3. 实验便利：快速测试不同参数组合
4. 配置分离：代码实现逻辑，launch定义具体配置
5. 团队协作：配置文档化，便于参数调优和知识共享
-->
<launch>

<!-- ================================ 仿真环境参数 ================================ -->
<!-- 这些参数定义3D仿真世界边界 -->
<arg name="map_size_x" default="50.0"/>  <!-- 世界X维度，单位米(东西方向) -->
<arg name="map_size_y" default="50.0"/>  <!-- 世界Y维度，单位米(南北方向) -->
<arg name="map_size_z" default=" 5.0"/>  <!-- 世界Z维度，单位米(上下方向，飞行高度上限) -->

<!-- 无人机在仿真中的初始生成位置 -->
<arg name="init_x" default="-20.0"/>     <!-- 无人机起始X坐标(米) -->
<arg name="init_y" default="-20.0"/>     <!-- 无人机起始Y坐标(米) -->
<arg name="init_z" default="  0.5"/>     <!-- 无人机起始高度(离地米数) -->

<!-- =============================== 1. 主轨迹规划器节点 =============================== -->
<!--
核心轨迹规划节点，实现BTraj算法
包名：bezier_planer (包含主要规划算法)
类型：b_traj_node (来自CMakeLists.txt的可执行文件名)
功能：整合前端路径搜索与后端贝塞尔轨迹优化
-->
  <node pkg="bezier_planer" type="b_traj_node" name="b_traj_node" output="screen">
      <!--
      ================================ ROS话题重映射机制详解 ================================

      重映射(remap)的作用：
      1. 代码复用性：节点代码使用相对话题名(如"waypoints")，可以灵活连接不同数据源
      2. 系统解耦：节点不需要硬编码具体话题路径，便于模块化开发
      3. 配置灵活：通过launch文件重新配置数据流，无需修改源码
      4. 调试方便：可以重定向到不同数据源进行测试

      语法解释：
      - from="~waypoints"：波浪号~表示私有话题，实际为 /节点名/waypoints
      - to="/absolute/path"：重定向到的绝对话题路径
      - 效果：代码中的相对话题名被替换为指定的绝对路径

      实际转换过程：
      代码: nh.subscribe("waypoints", callback)
      默认: /b_traj_node/waypoints
      重映射后: /waypoint_generator/waypoints

      类比：就像电话转接，拨分机号自动转到正确的目标号码
      -->

      <!-- 话题重映射：建立节点间的数据连接通道 -->
      <remap from="~waypoints"      to="/waypoint_generator/waypoints"/>      <!-- 输入：用户目标航点 -->
      <remap from="~odometry"       to="/odom/fake_odom"/>                    <!-- 输入：无人机位置/速度状态 -->
      <remap from="~map"            to="/random_forest_sensing/random_forest"/><!-- 输入：传感器障碍物地图 -->
      <remap from="~command"        to="/position_cmd"/>                      <!-- 输出：发给控制器的位置命令 -->

      <!-- 轨迹优化参数 -->
      <param name="optimization/poly_order"  value="8"/>   <!-- 贝塞尔多项式阶数(8阶=平滑轨迹) -->
      <param name="optimization/min_order"   value="2.5"/> <!-- 优化约束的最小导数阶数
                                                            小数值含义：在不同导数阶数间线性插值优化
                                                            1=速度, 2=加速度, 3=急动度, 4=snap
                                                            2.5 = 0.5×加速度优化 + 0.5×急动度优化
                                                            平衡轨迹平滑性与执行效率 -->

      <!-- 全局地图配置(使用启动参数) -->
      <param name="map/x_size"       value="$(arg map_size_x)"/>  <!-- 世界X边界 -->
      <param name="map/y_size"       value="$(arg map_size_y)"/>  <!-- 世界Y边界 -->
      <param name="map/z_size"       value="$(arg map_size_z)"/>  <!-- 世界Z边界 -->

      <!-- 局部规划窗口(无人机周围滑动窗口，提高计算效率) -->
      <!-- BUG (已修改) map/x_local_size写成了map/z_local_size -->
      <param name="map/x_local_size" value="16.0"/>  <!-- 局部规划窗口X尺寸(米) -->
      <param name="map/y_local_size" value="16.0"/>  <!-- 局部规划窗口Y尺寸(米) -->
      <param name="map/z_local_size" value="8.0" />  <!-- 局部规划窗口Z尺寸(米) -->

      <!-- 安全参数 -->
      <param name="map/margin"       value="0.2" />   <!-- 障碍物周围安全边距(米) -->

      <!-- 初始状态配置 -->
      <param name="planning/init_x"  value="$(arg init_x)"/>  <!-- 起始X位置 -->
      <param name="planning/init_y"  value="$(arg init_y)"/>  <!-- 起始Y位置 -->
      <param name="planning/init_z"  value="$(arg init_z)"/>  <!-- 起始Z位置 -->

      <!-- 路径搜索算法参数 -->
      <param name="planning/inflate_iter"  value="200"  />  <!-- 障碍物膨胀迭代次数，增加安全性 -->
      <param name="planning/step_length"   value="1"    />  <!-- 路径搜索网格步长(米) -->
      <param name="planning/cube_margin"   value="0.0"  />  <!-- 飞行走廊额外边距 -->

      <!-- 无人机动力学约束 -->
      <param name="planning/max_vel"       value="2.0"  />  <!-- 最大速度限制(m/s) -->
      <param name="planning/max_acc"       value="2.0"  />  <!-- 最大加速度限制(m/s²) -->

      <!-- 规划视野 -->
      <param name="planning/check_horizon" value="10.0" />  <!-- 碰撞检测前瞻距离(米) -->
      <param name="planning/stop_horizon"  value=" 3.0" />  <!-- 到达目标前开始减速距离(米) -->

      <!-- 约束执行标志 -->
      <param name="planning/is_limit_vel"  value="true" />  <!-- 在优化中启用速度约束 -->
      <param name="planning/is_limit_acc"  value="false"/>  <!-- 禁用加速度约束(依赖速度限制) -->

      <!-- 算法选择：关键参数 -->
      <param name="planning/is_use_fm"     value="true" />  <!-- true=Fast Marching*, false=A*算法 -->
      <!-- Fast Marching*: 更适合平滑路径，考虑速度场 -->
      <!-- A*: 计算更快，基于网格的离散搜索 -->

      <!-- 可视化参数 -->
      <param name="vis/vis_traj_width" value="0.15"/>   <!-- RViz中轨迹线宽度 -->
      <param name="vis/is_proj_cube"   value="false"/>  <!-- 显示/隐藏飞行走廊投影 -->
  </node>

<!-- =============================== 2. 里程计生成器节点 =============================== -->
<!--
仿真里程计生成器，模拟无人机的位置和速度反馈
功能：根据位置命令生成虚拟的里程计数据，用于闭环控制仿真
在真实系统中，这将被实际的传感器数据(IMU、GPS、视觉里程计等)替代
-->
  <node pkg  = "bezier_planer" type = "odom_generator" output = "screen" name = "odom_generator">
      <remap from = "~odometry"  to = "odom/fake_odom"/>  <!-- 输出：发布虚拟里程计数据 -->
      <remap from = "~command"   to = "/position_cmd"/>   <!-- 输入：接收位置命令来模拟运动 -->
      <param name="init_x"  value="$(arg init_x)"/>       <!-- 初始X坐标 -->
      <param name="init_y"  value="$(arg init_y)"/>       <!-- 初始Y坐标 -->
      <param name="init_z"  value="$(arg init_z)"/>       <!-- 初始Z坐标 -->
  </node>

<!-- =============================== 3. 轨迹服务器节点 =============================== -->
<!--
轨迹执行服务器，负责轨迹跟踪和执行
功能：
1. 接收 PolynomialTrajectory 消息(包含贝塞尔系数数组)
2. 重组为系数矩阵，支持多段不同阶数轨迹
3. 实时计算当前时刻的位置/速度/加速度
4. 发送 PositionCommand 给控制器

数据流：规划器系数数组 → 轨迹消息 → 服务器矩阵 → 实时位置指令
-->
  <node pkg  = "bezier_planer" type = "b_traj_server" output = "screen" name = "b_traj_server">
      <remap from = "~trajectory"        to = "b_traj_node/trajectory"/>  <!-- 输入：来自规划器的轨迹 -->
      <remap from = "~odometry"          to = "/odom/fake_odom"/>          <!-- 输入：当前位置状态 -->
      <remap from = "~position_command"  to = "/position_cmd"/>            <!-- 输出：位置控制命令 -->
      <param name="optimization/poly_order_min" value="3" />   <!-- 轨迹执行器支持的最小多项式阶数 -->
      <param name="optimization/poly_order_max" value="12"/>   <!-- 轨迹执行器支持的最大多项式阶数
                                                                当前项目：规划器固定输出8阶，服务器实际处理8阶
                                                                设计目的：系统扩展性，支持未来不同规划器(3-12阶)
                                                                应用场景：算法研究、性能调优、不同任务需求 -->
  </node>

<!-- =============================== 4. 航点生成器节点 =============================== -->
<!--
用户交互航点生成器，处理RViz中的3D导航目标
功能：将用户在RViz中点击的3D Nav Goal转换为规划器可用的航点
这是用户与规划系统交互的主要接口
-->
  <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator" output="screen">
      <remap from="~odom" to="/odom/fake_odom"/>        <!-- 输入：当前位置信息 -->
      <remap from="~goal" to="/goal"/>                  <!-- 输入：RViz 3D Nav Goal -->
      <param name="waypoint_type" value="manual-lonely-waypoint"/>  <!-- 单点手动航点模式 -->
  </node>

<!-- =============================== 5. 随机森林传感器节点 =============================== -->
<!--
环境仿真和传感器模拟节点
功能：
1. 生成随机森林障碍物环境
2. 模拟传感器(如激光雷达)的检测范围和精度
3. 提供局部障碍物地图给规划器
这模拟了真实世界中的环境感知系统
-->
  <node pkg ="bezier_planer" name ="random_forest_sensing" type ="random_forest_sensing" output = "screen">
      <remap from="~odometry"   to="/odom/fake_odom"/>    <!-- 输入：无人机位置，用于确定传感器位置 -->

      <!-- 传感器初始位置 -->
      <param name="init_state_x"   value="$(arg init_x)"/>
      <param name="init_state_y"   value="$(arg init_y)"/>

      <!-- 地图范围配置(与全局地图一致) -->
      <param name="map/x_size"     value="$(arg map_size_x)" />
      <param name="map/y_size"     value="$(arg map_size_y)" />
      <param name="map/z_size"     value="$(arg map_size_z)" />

      <!-- 障碍物生成参数 -->
      <param name="map/obs_num"    value="520"/>        <!-- 障碍物数量 -->
      <param name="map/resolution" value="0.2"/>        <!-- 地图分辨率(米/像素) -->

      <!-- 障碍物形状随机化范围 -->
      <param name="ObstacleShape/lower_rad" value="0.3"/>  <!-- 树干最小半径(米) -->
      <param name="ObstacleShape/upper_rad" value="1.6"/>  <!-- 树干最大半径(米) -->
      <param name="ObstacleShape/lower_hei" value="1.0"/>  <!-- 树木最小高度(米) -->
      <param name="ObstacleShape/upper_hei" value="6.0"/>  <!-- 树木最大高度(米) -->

      <!-- 传感器特性 -->
      <param name="sensing/radius" value="15.0"/>        <!-- 传感器检测半径(米) -->
      <param name="sensing/rate"   value="10.0"/>        <!-- 传感器更新频率(Hz) -->
  </node>

<!-- =============================== 6. 里程计可视化节点 =============================== -->
<!--
RViz可视化支持节点，显示无人机状态
功能：在RViz中显示无人机的位置、姿态和不确定性
包含轨迹历史和协方差椭球显示
-->
  <node pkg="odom_visualization" name="odom_visualization_ukf_" type="odom_visualization" output="screen">
      <remap from="~odom" to="/odom/fake_odom"/>     <!-- 输入：里程计数据 -->

      <!-- 可视化颜色配置(RGBA) -->
      <param name="color/a" value="0.8"/>    <!-- 透明度 -->
      <param name="color/r" value="0.0"/>    <!-- 红色分量 -->
      <param name="color/g" value="0.0"/>    <!-- 绿色分量 -->
      <param name="color/b" value="0.0"/>    <!-- 蓝色分量 -->

      <!-- 可视化缩放参数 -->
      <param name="covariance_scale" value="100.0"/>  <!-- 协方差椭球放大倍数 -->
      <param name="robot_scale" value="1.0"/>         <!-- 无人机模型缩放 -->
  </node>

<!-- =============================== 7. RViz 3D可视化界面 =============================== -->
<!--
RViz 3D可视化工具启动
加载预配置的显示设置，包括：
- 地图显示
- 轨迹可视化
- 无人机状态
- 3D Nav Goal工具(用户交互)
配置文件：simulation.rviz
-->
  <node name="rvizvisualisation" pkg="rviz" type="rviz" output="log" args="-d $(find bezier_planer)/launch/rviz_config/simulation.rviz" />

</launch>